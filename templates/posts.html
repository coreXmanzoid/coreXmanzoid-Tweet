{% if not posts %}
<div class="no-posts text-center py-5">
    <i class="bi bi-inbox" style="font-size:48px;opacity:.3"></i>
    <h4 class="no-data mt-3">No posts yet</h4>
    <p class="text-muted">There are no posts to show. Create the first post to get started.</p>
</div>
{% endif %}
{% for post in posts %}
<div class="post {{ post.id }} info" data-postid="{{post.id}}">
    <div class="post-heading">
        <img src="{{ post.user.profile_image_url if post.user.profile_image_url else url_for('static', filename='assets/default-profile.jpg') }}" alt="" width="40" height="40" class="rounded-circle me-2">
        <h5 class="{{ post.user.id }}">{{ post.user.name }}<br /><span>@{{ post.user.username }}</span></h5>
        {% if reposts %}
        <p class="ps-2 text-muted fs-6 d-none d-md-inline">
            <svg xmlns="http://www.w3.org/2000/svg" height="15" width="15" viewBox="0 0 640 640">
                <path d="M534.6 182.6C547.1 170.1 547.1 149.8 534.6 137.3L470.6 73.3C461.4 64.1 447.7 
                61.4 435.7 66.4C423.7 71.4 416 83.1 416 96L416 128L256 128C150 128 64 214 64 320C64 337.7 
                78.3 352 96 352C113.7 352 128 337.7 128 320C128 249.3 185.3 192 256 192L416 192L416 
                224C416 236.9 423.8 248.6 435.8 253.6C447.8 258.6 461.5 255.8 470.7 246.7L534.7 
                182.7zM105.4 457.4C92.9 469.9 92.9 490.2 105.4 502.7L169.4 566.7C178.6 575.9 192.3 
                578.6 204.3 573.6C216.3 568.6 224 556.9 224 544L224 512L384 512C490 512 576 426 576 
                320C576 302.3 561.7 288 544 288C526.3 288 512 302.3 512 320C512 390.7 454.7 448 384 
                448L224 448L224 416C224 403.1 216.2 391.4 204.2 386.4C192.2 381.4 178.5 384.2 169.3 
                393.3L105.3 457.3z"/></svg> 
                <span> {{ reposts }} </span> reposted</p>
        {% else %}
        <small>{{ post.timestamp }}</small>
        {% endif %}
    </div>
    <div class="post-content">
        <p class="content">{{ post.content }}</p>
        <p class="hashtag">{{ ' '.join(post.hashtags) }}</p>
    </div>
    <div class="post-actions">
        <a class="comment"><i class="bi bi-chat-heart"></i> {{ post.comments }}</a>
        {% if post.id in current_user.reposted_posts %}
        <a class="retweet text-warning"><i class="bi bi-repeat"></i> {{ post.retweets }}</a>
        {% else %}
        <a class="retweet"><i class="bi bi-repeat"></i> {{ post.retweets }}</a>
        {% endif %}
        {% if post.id in current_user.liked_posts %}
        <a class="like"><i class="bi bi-heart-fill"></i> {{ post.likes }}</a>
        {% else %}
        <a class="like"><i class="bi bi-heart"></i> {{ post.likes }}</a>
        {% endif %}
        <a class="share"><i class="bi bi-share"></i> {{ post.shares }}</a>
    </div>
    <hr>
</div>
{% endfor %}
<script>

    // Like button functionality
    // Like / Unlike handler (works with AJAX-loaded content)
    $(document).on("click", ".like", function (e) {
        e.preventDefault();

        var $btn = $(this);
        var $icon = $btn.find("i");

        var wasLiked = $icon.hasClass("bi-heart-fill");
        var postId = $btn.closest(".post").data("postid");

        $.ajax({
            url: "/likePost/1",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                post_id: postId,
                like: !wasLiked
            }),
            success: function (res) {

                // Update UI ONLY after backend success
                if (wasLiked) {
                    // Was liked, now unliked
                    $btn.removeClass("text-warning");
                    $icon.removeClass("bi-heart-fill").addClass("bi-heart");
                } else {
                    // Was unliked, now liked
                    $btn.addClass("text-warning");
                    $icon.removeClass("bi-heart").addClass("bi-heart-fill");
                }
                // Update count safely
                var textNode = $btn.contents().filter(function () {
                    return this.nodeType === 3;
                }).first();

                if (textNode.length) {
                    textNode[0].nodeValue = " " + res.likes;
                } else {
                    $btn.append(" " + res.likes);
                }
            }
        });
    });

    $(document).on("click", ".retweet", function (e) {
        e.preventDefault();

        var $btn = $(this);
        var $icon = $btn.find("i");

        var wasreposted = $btn.hasClass("text-warning");
        var postId = $btn.closest(".post").data("postid");

        $.ajax({
            url: "/likePost/2",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                post_id: postId,
                repost: !wasreposted
            }),
            success: function (res) {
                // Update UI ONLY after backend success
                if (wasreposted) {
                    // Was liked, now unliked
                    $btn.removeClass("text-warning");
                } else {
                    // Was unliked, now liked
                    $btn.addClass("text-warning");
                }
                // rotate icon a full cycle
                $icon.removeClass('rotate');
                void $icon[0].offsetWidth; // force reflow
                $icon.addClass('rotate');
                // Update count safely
                var textNode = $btn.contents().filter(function () { return this.nodeType === 3; }).first();
                if (textNode.length) {
                    textNode[0].nodeValue = " " + res.reposts;
                } else {
                    $btn.append(" " + res.reposts);
                }
            }
        });
    });

    // share button functionality
    $(".share").click(function (e) {
        e.preventDefault();
        var $btn = $(this);
        var wasshare = $btn.hasClass("text-warning");
        $btn.toggleClass("text-warning");

        var $post = $btn.closest(".post");
        var text = $post.find(".post-content").text().trim();

        navigator.clipboard.writeText(text).then(() => alert("Post copied to clipboard!"))

        var textNode = $btn.contents().filter(function () {
            return this.nodeType === 3;
        }).first();

        var count = 0;
        if (textNode.length) {
            var txt = textNode[0].nodeValue.trim();
            var m = txt.match(/\d+/);
            count = m ? parseInt(m[0], 10) : 0;
            count = Math.max(0, count + (wasshare ? -1 : 1));
            textNode[0].nodeValue = " " + count;
        } else {
            count = wasshare ? 0 : 1;
            $btn.append(" " + count);
        }
    });
    // Display relative time for posts
    const current_time = new Date(time_now);
    $(".post-heading small").each(function () {
        const post_time_str = $(this).text();  // Example: "2025-10-30T13:55:00"
        const post_time = new Date(post_time_str);
        const diffMs = current_time - post_time;
        const diffMins = Math.floor(diffMs / 60000);

        let display = "";

        if (diffMins < 1) {
            display = "Just now";
        } else if (diffMins < 60) {
            display = diffMins + " min ago";
        } else if (diffMins < 1440) {
            display = Math.floor(diffMins / 60) + "h ago";
        } else if (diffMins < 43200) {
            display = Math.floor(diffMins / 1440) + "d ago";
        } else if (diffMins < 525600) {
            display = Math.floor(diffMins / 43200) + "m ago";
        } else {
            display = Math.floor(diffMins / 525600) + "y ago";
        }

        $(this).text(display);
    });

    // Show comments section on double click of post
    $(".post").dblclick(showFullPost);
    $(".comment").click(showFullPost);
    // Show user profile on clicking user name
    $(".post-heading h5").click(function () {
        var post_id = $(this).attr("class");
        showProfile(post_id);
    });
</script>