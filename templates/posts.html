{% if not posts %}
<div class="no-posts text-center py-5">
    <i class="bi bi-inbox" style="font-size:48px;opacity:.3"></i>
    <h4 class="no-data mt-3">No posts yet</h4>
    <p class="text-muted">There are no posts to show. Create the first post to get started.</p>
</div>
{% endif %}
{% for post in posts %}
<div class="post {{ post.id }} info" data-postid="{{post.id}}">
    <div class="post-heading">
        <img src="{{ post.user.profile_image_url if post.user.profile_image_url else url_for('static', filename='assets/default-profile.jpg') }}"
            alt="" width="40" height="40" class="rounded-circle me-2">
        <h5 class="{{ post.user.id }}">{{ post.user.name }}<br /><span>@{{ post.user.username }}</span></h5>
        {% if reposts %}
        <p class="ps-2 text-muted fs-6 d-none d-md-inline">
            <svg xmlns="http://www.w3.org/2000/svg" height="15" width="15" viewBox="0 0 640 640">
                <path d="M534.6 182.6C547.1 170.1 547.1 149.8 534.6 137.3L470.6 73.3C461.4 64.1 447.7 
                61.4 435.7 66.4C423.7 71.4 416 83.1 416 96L416 128L256 128C150 128 64 214 64 320C64 337.7 
                78.3 352 96 352C113.7 352 128 337.7 128 320C128 249.3 185.3 192 256 192L416 192L416 
                224C416 236.9 423.8 248.6 435.8 253.6C447.8 258.6 461.5 255.8 470.7 246.7L534.7 
                182.7zM105.4 457.4C92.9 469.9 92.9 490.2 105.4 502.7L169.4 566.7C178.6 575.9 192.3 
                578.6 204.3 573.6C216.3 568.6 224 556.9 224 544L224 512L384 512C490 512 576 426 576 
                320C576 302.3 561.7 288 544 288C526.3 288 512 302.3 512 320C512 390.7 454.7 448 384 
                448L224 448L224 416C224 403.1 216.2 391.4 204.2 386.4C192.2 381.4 178.5 384.2 169.3 
                393.3L105.3 457.3z" />
            </svg>
            <span> {{ reposts }} </span> reposted
        </p>
        {% else %}
        <small class="post-time" data-timestamp="{{ post.timestamp.isoformat() }}Z">
            {{ post.timestamp.strftime('%d %b %Y, %I:%M %p') }}Z
        </small>

        {% endif %}

        {% if time_now - post.timestamp < timedelta(minutes=3) and post.user.id==current_user.id %}
        <div class="edit-post ms-auto me-2" title="Edit Post">
            <svg style="width: 22px; cursor:pointer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M505 122.9L517.1 135C526.5 144.4 526.5 159.6 517.1 168.9L488 198.1L441.9 152L471 122.9C480.4 113.5 495.6 113.5 504.9 122.9zM273.8 320.2L408 185.9L454.1 232L319.8 366.2C316.9 369.1 313.3 371.2 309.4 372.3L250.9 389L267.6 330.5C268.7 326.6 270.8 323 273.7 320.1zM437.1 89L239.8 286.2C231.1 294.9 224.8 305.6 221.5 317.3L192.9 417.3C190.5 425.7 192.8 434.7 199 440.9C205.2 447.1 214.2 449.4 222.6 447L322.6 418.4C334.4 415 345.1 408.7 353.7 400.1L551 202.9C579.1 174.8 579.1 129.2 551 101.1L538.9 89C510.8 60.9 465.2 60.9 437.1 89zM152 128C103.4 128 64 167.4 64 216L64 488C64 536.6 103.4 576 152 576L424 576C472.6 576 512 536.6 512 488L512 376C512 362.7 501.3 352 488 352C474.7 352 464 362.7 464 376L464 488C464 510.1 446.1 528 424 528L152 528C129.9 528 112 510.1 112 488L112 216C112 193.9 129.9 176 152 176L264 176C277.3 176 288 165.3 288 152C288 138.7 277.3 128 264 128L152 128z"/></svg>
        </div>
        {% endif %}
    </div>
    <div class="post-content">
        <p class="content">{{ post.content }}</p>
        <p class="hashtag">{{ ' '.join(post.hashtags) }}</p>
    </div>
    <div class="post-actions">
        <a class="comment"><i class="bi bi-chat-heart"></i> {{ post.comments }}</a>
        {% if post.id in current_user.reposted_posts %}
        <a class="retweet text-warning"><i class="bi bi-repeat"></i> {{ post.retweets }}</a>
        {% else %}
        <a class="retweet"><i class="bi bi-repeat"></i> {{ post.retweets }}</a>
        {% endif %}
        {% if post.id in current_user.liked_posts %}
        <a class="like"><i class="bi bi-heart-fill"></i> {{ post.likes }}</a>
        {% else %}
        <a class="like"><i class="bi bi-heart"></i> {{ post.likes }}</a>
        {% endif %}
        <a class="share"><i class="bi bi-share"></i> {{ post.shares }}</a>
    </div>
    <hr>
</div>
{% endfor %}
<script>

    $(".edit-post").click(function () {
        var editLink = $(this);
        var postDiv = editLink.closest(".post");
        var postId = postDiv.data("postid");
        var contentP = postDiv.find(".post-content .content");
        var originalContent = contentP.text().trim();

        // Replace content with textarea
        var textarea = $('<textarea class="form-control" maxlength="180" rows="3" ></textarea>').val(originalContent);
        contentP.replaceWith(textarea);

        // Create buttons
        var deleteBtn = $('<small class="edit-action delete"><u>Delete</u></small>');
        var saveBtn = $('<small class="edit-action save"><u>Save</u></small>');
        var cancelBtn = $('<small class="edit-action cancel"><u>Cancel</u></small>');

        // Append buttons under the edit link
        var btnContainer = $('<div class="edit-btn-container m-1" style="display:flex; justify-content:space-between;"></div>');
        btnContainer.append(deleteBtn, cancelBtn, saveBtn);
        postDiv.find(".post-content").after(btnContainer);

        // Hide the edit link while editing
        editLink.hide();

        // Save button click handler
        saveBtn.click(function () {
            confirm_change = confirm("Do you want to update you post. This action cannot be undone.");
            if (confirm_change){

                var newContent = textarea.val().trim();
                $.ajax({
                url: "/managePosts/2",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    post_id: postId,
                    content: newContent
                }),
                success: function (res) {
                    // Update content

                    var newContentP = $('<p class="content"></p>').text(res["content"]);
                    textarea.replaceWith(newContentP);

                    // Remove buttons, show edit link
                    btnContainer.remove();
                    editLink.show();
                }
            });
        }
        });

        // Cancel button click handler
        cancelBtn.click(function () {
            var originalContentP = $('<p class="content"></p>').text(originalContent);
            textarea.replaceWith(originalContentP);

            // Remove buttons, show edit link
            btnContainer.remove();
            editLink.show();
        });

        // Delete button click handler
        deleteBtn.click(function () {
            confirm_change = confirm("Are you sure you want to delete this post? This action cannot be undone.");
            if (confirm_change){
            $.ajax({
                url: "/managePosts/3",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    post_id: postId,
                }),
            
                success: function (res) {
                    // Remove post from UI
                    postDiv.remove();
                }
            });
        }
        });
    });

    // Like button functionality
    // Like / Unlike handler (works with AJAX-loaded content)
    $(document).on("click", ".like", function (e) {
        e.preventDefault();

        var $btn = $(this);
        var $icon = $btn.find("i");

        var wasLiked = $icon.hasClass("bi-heart-fill");
        var postId = $btn.closest(".post").data("postid");

        $.ajax({
            url: "/likePost/1",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                post_id: postId,
                like: !wasLiked
            }),
            success: function (res) {

                // Update UI ONLY after backend success
                if (wasLiked) {
                    // Was liked, now unliked
                    $btn.removeClass("text-warning");
                    $icon.removeClass("bi-heart-fill").addClass("bi-heart");
                } else {
                    // Was unliked, now liked
                    $btn.addClass("text-warning");
                    $icon.removeClass("bi-heart").addClass("bi-heart-fill");
                }
                // Update count safely
                var textNode = $btn.contents().filter(function () {
                    return this.nodeType === 3;
                }).first();

                if (textNode.length) {
                    textNode[0].nodeValue = " " + res.likes;
                } else {
                    $btn.append(" " + res.likes);
                }
            }
        });
    });

    $(document).on("click", ".retweet", function (e) {
        e.preventDefault();

        var $btn = $(this);
        var $icon = $btn.find("i");

        var wasreposted = $btn.hasClass("text-warning");
        var postId = $btn.closest(".post").data("postid");

        $.ajax({
            url: "/likePost/2",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                post_id: postId,
                repost: !wasreposted
            }),
            success: function (res) {
                // Update UI ONLY after backend success
                if (wasreposted) {
                    // Was liked, now unliked
                    $btn.removeClass("text-warning");
                } else {
                    // Was unliked, now liked
                    $btn.addClass("text-warning");
                }
                // rotate icon a full cycle
                $icon.removeClass('rotate');
                void $icon[0].offsetWidth; // force reflow
                $icon.addClass('rotate');
                // Update count safely
                var textNode = $btn.contents().filter(function () { return this.nodeType === 3; }).first();
                if (textNode.length) {
                    textNode[0].nodeValue = " " + res.reposts;
                } else {
                    $btn.append(" " + res.reposts);
                }
            }
        });
    });

    // share button functionality
    $(".share").click(function (e) {
        e.preventDefault();
        var $btn = $(this);
        var wasshare = $btn.hasClass("text-warning");
        $btn.toggleClass("text-warning");

        var $post = $btn.closest(".post");
        var text = $post.find(".post-content").text().trim();

        navigator.clipboard.writeText(text).then(() => alert("Post copied to clipboard!"))

        var textNode = $btn.contents().filter(function () {
            return this.nodeType === 3;
        }).first();

        var count = 0;
        if (textNode.length) {
            var txt = textNode[0].nodeValue.trim();
            var m = txt.match(/\d+/);
            count = m ? parseInt(m[0], 10) : 0;
            count = Math.max(0, count + (wasshare ? -1 : 1));
            textNode[0].nodeValue = " " + count;
        } else {
            count = wasshare ? 0 : 1;
            $btn.append(" " + count);
        }
    });

    $(".post-heading small").each(function () {
        const post_time_str = $(this).data("timestamp"); // READ from data attribute
        const post_time = new Date(post_time_str);

        const current_time = new Date(); // browser current time
        const diffMs = current_time - post_time;
        const diffMins = Math.floor(diffMs / 60000);

        let display = "";
        if (diffMins < 1) {
            display = "Just now";
        } else if (diffMins < 60) {
            display = diffMins + " min ago";
        } else if (diffMins < 1440) {
            display = Math.floor(diffMins / 60) + " hours ago";
        } else {
            display = Math.floor(diffMins / 1440) + " days ago";
        }

        $(this).text(display);
    });


    // Show comments section on double click of post
    $(".post").dblclick(showFullPost);
    $(".comment").click(showFullPost);
    // Show user profile on clicking user name
    $(".post-heading h5").click(function () {
        var post_id = $(this).attr("class");
        showProfile(post_id);
    });
</script>