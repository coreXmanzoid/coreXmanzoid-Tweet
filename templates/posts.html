{% for post in posts %}
<div class="post">
    <div class="post-heading">
        <img src="https://github.com/mdo.png" alt="" width="40" height="40" class="rounded-circle me-2">
        <h5 class="{{ post.id }}">{{ post.user.name }}<br /><span>@{{ post.user.username }}</span></h5>
        <small>{{ post.timestamp }}</small>
    </div>
    <div class="post-content">
        <p class="content">{{ post.content }}</p>
        <p class="hashtag">{{ ' '.join(post.hashtags) }}</p>
    </div>
    <div class="post-actions">
        <a class="comment"><i class="bi bi-chat-heart"></i> {{ post.comments }}</a>
        <a class="retweet"><i class="bi bi-repeat"></i> {{ post.retweets }}</a>
        <a class="like"><i class="bi bi-heart"></i> {{ post.likes }}</a>
        <a class="share"><i class="bi bi-share"></i> {{ post.shares }}</a>
    </div>
    <hr>
</div>
{% endfor %}
<script>

// Like button functionality
$(".like").click(function (e) {
    e.preventDefault();
    var $btn = $(this);
    var $icon = $btn.find("i");
    var wasLiked = $icon.hasClass("bi-heart-fill");

    // toggle heart icon
    $btn.toggleClass("text-warning");
    $icon.toggleClass("bi-heart bi-heart-fill");

    // get the text node that holds the count (if any)
    var textNode = $btn.contents().filter(function () { return this.nodeType === 3; }).first();
    var count = 0;

    if (textNode.length) {
        var txt = textNode[0].nodeValue.trim();
        var m = txt.match(/\d+/);
        count = m ? parseInt(m[0], 10) : 0;
        count = Math.max(0, count + (wasLiked ? -1 : 1));
        textNode[0].nodeValue = " " + count;
    } else {
        // no count present yet -> create one
        count = wasLiked ? 0 : 1;
        $btn.append(" " + count);
    }
});
// share button functionality
$(".share").click(function (e) {
    e.preventDefault();
    var $btn = $(this);
    var wasshare = $btn.hasClass("text-warning");
    $btn.toggleClass("text-warning");

    var $post = $btn.closest(".post");
    var text = $post.find(".post-content").text().trim();

    navigator.clipboard.writeText(text).then(() => alert("Post copied to clipboard!"))

    var textNode = $btn.contents().filter(function () {
        return this.nodeType === 3;
    }).first();

    var count = 0;
    if (textNode.length) {
        var txt = textNode[0].nodeValue.trim();
        var m = txt.match(/\d+/);
        count = m ? parseInt(m[0], 10) : 0;
        count = Math.max(0, count + (wasshare ? -1 : 1));
        textNode[0].nodeValue = " " + count;
    } else {
        count = wasshare ? 0 : 1;
        $btn.append(" " + count);
    }
});

// retweet button functionality
$(".retweet").click(function (e) {
    e.preventDefault();
    var $btn = $(this);
    var $icon = $btn.find("i");

    var wasshare = $btn.hasClass("text-warning");
    $btn.toggleClass("text-warning");
    // rotate icon a full cycle
    $icon.removeClass('rotate');
    void $icon[0].offsetWidth; // force reflow
    $icon.addClass('rotate');

    // get the text node that holds the count (if any)
    var textNode = $btn.contents().filter(function () { return this.nodeType === 3; }).first();
    var count = 0;

    if (textNode.length) {
        var txt = textNode[0].nodeValue.trim();
        var m = txt.match(/\d+/);
        count = m ? parseInt(m[0], 10) : 0;
        count = Math.max(0, count + (wasshare ? -1 : 1));
        textNode[0].nodeValue = " " + count;
    } else {
        // no count present yet -> create one
        count = wasshare ? 0 : 1;
        $btn.append(" " + count);
    }

});
// Display relative time for posts
const current_time = new Date(time_now);
$(".post-heading small").each(function() {
    const post_time_str = $(this).text();  // Example: "2025-10-30T13:55:00"
    const post_time = new Date(post_time_str);
    const diffMs = current_time - post_time;
    const diffMins = Math.floor(diffMs / 60000);

    let display = "";

    if (diffMins < 1) {
        display = "Just now";
    } else if (diffMins < 60) {
        display = diffMins + " min ago";
    } else if (diffMins < 1440) {
        display = Math.floor(diffMins / 60) + "h ago";
    } else if (diffMins < 43200) {
        display = Math.floor(diffMins / 1440) + "d ago";
    } else if (diffMins < 525600) {
        display = Math.floor(diffMins / 43200) + "m ago";
    } else {
        display = Math.floor(diffMins / 525600) + "y ago";
    }

    $(this).text(display);
});

// Show comments section on double click of post
$(".post").dblclick(function () {
    var $post = $(this);
    var post_id = $post.find('.post-heading h5').attr("class");
    var active_post = $post.hasClass("active-post");

    $(".post").removeClass("active-post");

    if (!active_post) {
        $post.addClass("active-post");
        $(".explore-tab").hide();

        // Get user name
        const userName = $post.find('.post-heading h5').clone().children().remove().end().text().trim();
        // Get username (@username inside span)
        const userHandle = $post.find('.post-heading h5 span').text().trim().replace(/^@/, '');
        // Get timestamp
        const timestamp = $post.find('.post-heading small').text().trim();
        const like = $post.find('.like').text().trim();
        const shares = $post.find('.share').text().trim();
        const comment = $post.find('.comment').text().trim();
        const retweet = $post.find('.retweet').text().trim();
        const content = $post.find('.post-content p.content').text().trim();
        const hashtag = $post.find('.post-content p.hashtag').text().trim();

        // Fill in post data dynamically
        $(".commmentpost-action .likes span").text(like);
        $(".commmentpost-action .comments span").text(comment);
        $(".commmentpost-action .retweets span").text(retweet);
        $(".commmentpost-action .shares span").text(shares);

        // Fixed invalid selector $(".4") â€” use .full-post or specific container
        $(".full-post .post-heading h5").html(`${userName}<br><span>@${userHandle}</span>`);
        $(".full-post .post-heading small").text(timestamp);
        $(".full-post .post-content p.content").text(content);
        $(".full-post .post-content p.hashtag").text(hashtag);

        $(".full-post").show();
        // reload sepecific part of page without refreshing entire page and implementing on specific div
        $('.all-comments').load('/comments/' + post_id + '/nill/0');
    } else {
        $post.removeClass("active-post");
        $(".explore-tab").show();
        $(".full-post").hide();
    }
});
</script>