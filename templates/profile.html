<div class="container">
    <div class="profile-header d-flex justify-content-between align-items-center p-2">
        <div class="p">
            <i class="backtohome bi bi-arrow-left"></i>
            <a href="">Home</a>
        </div>
        <i class="bi bi-three-dots"></i>
    </div>
    <img class="img-fluid ps-5 w-75 ms-5 " src="../static/assets/logo1.png">
    <div class="profile row">
        <div class="info col-lg-6" data-user-id="{{user.id}}">
            <div class="profile-pic-wrapper">
                <img class="profile-pic"
                    src="{{ user.profile_image_url if user.profile_image_url else url_for('static', filename='assets/default-profile.jpg') }}"
                    style="border-radius:50px;border: 2px solid #DEDED1;" width="100" height="100" class="m-2">
                {% if current_user.id == user.id %}
                <div class="profile-pic-overlay">Update</div>
                <input type="file" name="profile" id="profileInput">
                {% endif %}
                <br>
            </div>
            <small>
                <h5 style="display: inline;"><b>{{user.name}}</b></h5><i class="bi bi-patch-check-fill m-1"></i>
            </small>
            <h6>@{{user.username}}</h6>
            <small>
                <i class="bi bi-calendar-heart m-1"></i>
                <span id="birthDate">{{ user.birth_date }}</span>
            </small> <br>
            <small><em>Always coding...</em></small>
        </div>
        <div class="audience {{user.id}} col-lg-6 pt-3">
            {% if current_user.id == user.id %}
            <small class="edit-profile">Edit Profile</small> <br>
            {% elif is_following %}
            <small class="Following ps-3">Following</small> <br>
            {% else %}
            <small class="Follow ps-4">Follow</small> <br>
            {% endif %}
            <strong class="followers {{user.id}}" style="color: #F94818;">{{user.followers | length}} Followers</strong>
            <strong class="followings {{user.id}}">{{user.following | length}} Following</strong>
        </div>
        <hr style="margin:0px;">
        <div class="ProfileOptions {{user.id}}">
            {% if current_user.id == user.id %}
            <a>Posts</a>
            <hr>
            <a>Likes</a>
            <hr>
            <a>Reposts</a>
            <hr>
            <a>Dummy</a>
            {% else %}
            <a>Posts</a>
            <hr>
            <a>Reposts</a>
            <hr>
            <a>Dummy</a>
            {% endif %}
        </div>
    </div>

    <hr style="margin: 0px 0px 15px 0px;">
</div>
<script>
    $(".backtohome").click(Backtohome);
    $(".div2").show();

    $(".profile-pic-wrapper").on("click", function () {
        $(this).find("#profileInput").trigger("click");
    });

    $("#profileInput").on("change", function () {
        const wrapper = $(this).closest(".info");
        const userId = wrapper.data("user-id");
        user_choice = confirm("Are you sure you want to update your profile picture?");
        if (user_choice) {
            uploadProfileImage(this, `/update-profile/${userId}`);
        }
    });

    const rawDate = $("#birthDate").text().trim();

    if (rawDate) {
        const dateObj = new Date(rawDate);

        const formattedDate = dateObj.toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric"
        });

        $("#birthDate").text(formattedDate);
    }

    const d = new Date(rawDate);
    const formatted =
        String(d.getDate()).padStart(2, "0") + " " +
        d.toLocaleString("en-GB", { month: "short" }) + ", " +
        d.getFullYear();

    $("#birthDate").text(formatted);

    function uploadProfileImage(input, url) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("profile", file);

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.image_url) {
                    $(input)
                        .closest(".profile-pic-wrapper")
                        .find(".profile-pic")
                        .attr("src", res.image_url);
                }
            },
            error: function (err) {
                console.error(err.responseJSON || err);
            }
        });
    }


    $('.audience small').click(function () {
        let btn = $(this);   // <-- THIS is the actual element
        let button = btn.attr('class').split(' ')[0];
        let accountId = $(this).closest('.audience').attr('class').split(' ')[1];

        if (button === 'Follow') {
            $.ajax({
                url: '/follows/' + accountId + '/1',
                type: 'POST',
                success: function (response) {
                    btn.text('Following');      // update text
                    btn.attr('class', 'Following ps-3'); // update class
                }
            });
        } else {
            $.ajax({
                url: '/follows/' + accountId + '/2',
                type: 'POST',
                success: function (response) {
                    btn.text('Follow');
                    btn.attr('class', 'Follow ps-4');
                }
            });
        }
    });
    $(".followers").click(function () {
        exploreAccounts("/exploreAccounts/" + $(".followers").attr("class").split(' ')[1] + "/followers");
    });
    $(".followings").click(function () {
        exploreAccounts("/exploreAccounts/" + $(".followings").attr("class").split(' ')[1] + "/following");
    });
    $(".ProfileOptions a:first").addClass("active-a");
    $(".profileOptions a").click(function () {
        let option = $(this).text();
        let userId = $(".ProfileOptions").attr("class").split(' ')[1];
        if (option === "Posts") {
            showPosts(1, userId);
        } else if (option === "Likes") {
            showPosts(3, userId);
        } else if (option === "Reposts") {
            showPosts(4, userId);
        }
    })
</script>